<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì°¨ëŸ‰ë²ˆí˜¸ ì¡°íšŒ Â· ë“±ë¡</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (XLSX) CDN -->
  <script src="https://unpkg.com/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
  <style>
    /* iOS input zoom ë°©ì§€ */
    @supports (-webkit-touch-callout: none) {
      input, select, textarea, button { font-size: 16px; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-md mx-auto px-4 py-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold tracking-tight">ì°¨ëŸ‰ë²ˆí˜¸ ì¡°íšŒ Â· ë“±ë¡</h1>
      <p class="text-sm text-gray-600 mt-1">ì—‘ì…€ ì—…ë¡œë“œ Â· ë®ì–´ì“°ê¸°/ì¶”ê°€ ë°˜ì˜ Â· ë’·ìë¦¬ 4ìë¦¬ ê²€ìƒ‰</p>
    </header>

    <!-- ì—…ë¡œë“œ ì¹´ë“œ -->
    <section class="bg-white rounded-2xl shadow-sm p-4 mb-5">
      <h2 class="font-semibold mb-3">ì—‘ì…€ ì—…ë¡œë“œ</h2>
      <p class="text-sm text-gray-600 mb-3">ì»¬ëŸ¼: <b>ì´ë¦„, ì†Œì†, ì „í™”ë²ˆí˜¸, ì°¨ëŸ‰ë²ˆí˜¸</b> (ì²« í–‰ í—¤ë”)</p>
      <div class="flex items-center gap-2">
        <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" class="grow file:mr-3 file:py-2 file:px-3 file:rounded-xl file:border-0 file:bg-gray-100 file:text-gray-700 file:cursor-pointer border rounded-xl p-2" />
        <button id="btnImport" class="shrink-0 px-4 py-2 rounded-xl bg-blue-600 text-white font-medium">ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <p id="importMsg" class="text-sm text-gray-700 mt-3 hidden"></p>
      <div class="flex items-center justify-between mt-3">
        <p class="text-xs text-gray-500">í˜„ì¬ ì €ì¥ëœ ë°ì´í„°: <span id="count">0</span>ê±´</p>
        <div class="flex gap-2">
          <button id="btnExport" class="px-3 py-2 rounded-xl bg-gray-100 text-gray-800 text-sm">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
          <button id="btnClear" class="px-3 py-2 rounded-xl bg-rose-50 text-rose-600 text-sm">ì „ì²´ì‚­ì œ</button>
        </div>
      </div>
    </section>

    <!-- ê²€ìƒ‰ ì¹´ë“œ -->
    <section class="bg-white rounded-2xl shadow-sm p-4 mb-5">
      <h2 class="font-semibold mb-3">ì°¨ëŸ‰ë²ˆí˜¸ ë’·ìë¦¬ ê²€ìƒ‰</h2>
      <div class="flex gap-2">
        <input id="searchLast4" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="ë’·ìë¦¬ 4ìë¦¬" class="grow border rounded-xl px-3 py-2" />
        <button id="btnSearch" class="shrink-0 px-4 py-2 rounded-xl bg-blue-600 text-white font-medium">ê²€ìƒ‰</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">ì˜ˆ: 1234</p>
      <div id="searchResult" class="mt-4"></div>
    </section>

    <!-- ë“±ë¡ ì¹´ë“œ -->
    <section class="bg-white rounded-2xl shadow-sm p-4">
      <h2 class="font-semibold mb-3">ì‹ ê·œ ë“±ë¡</h2>
      <form id="addForm" class="grid grid-cols-1 gap-3">
        <div>
          <label class="block text-sm mb-1" for="name">ì´ë¦„</label>
          <input id="name" class="w-full border rounded-xl px-3 py-2" placeholder="í™ê¸¸ë™" required />
        </div>
        <div>
          <label class="block text-sm mb-1" for="dept">ì†Œì†</label>
          <input id="dept" class="w-full border rounded-xl px-3 py-2" placeholder="ì´ë¬´íŒ€" required />
        </div>
        <div>
          <label class="block text-sm mb-1" for="phone">ì „í™”ë²ˆí˜¸</label>
          <input id="phone" class="w-full border rounded-xl px-3 py-2" placeholder="010-1234-5678" required />
        </div>
        <div>
          <label class="block text-sm mb-1" for="plate">ì°¨ëŸ‰ë²ˆí˜¸</label>
          <input id="plate" class="w-full border rounded-xl px-3 py-2" placeholder="12ê°€3456" required />
          <p class="text-xs text-gray-500 mt-1">í•˜ì´í”ˆ/ë„ì–´ì“°ê¸° ë¬´ê´€. ë“±ë¡ ì‹œ ìë™ ì •ê·œí™”</p>
        </div>
        <button class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold">ë“±ë¡í•˜ê¸°</button>
      </form>
      <p id="addMsg" class="text-sm mt-3 hidden"></p>
    </section>

    <footer class="text-center text-xs text-gray-400 mt-6">Â© ì°¨ëŸ‰ë²ˆí˜¸ ì¡°íšŒ íˆ´</footer>
  </div>

  <script>
    // --- ìœ í‹¸ ---
    const STORAGE_KEY = 'vehicleData_v1';

    function normalizePlate(plate) {
      if (!plate) return '';
      // ìˆ«ì+í•œê¸€+ì˜ë¬¸ í—ˆìš©, í•˜ì´í”ˆ/ê³µë°± ì œê±°, ëŒ€ë¬¸ìí™”
      return plate
        .toString()
        .trim()
        .replace(/\s|-/g, '')
        .toUpperCase();
    }

    function last4(plate) {
      const p = normalizePlate(plate);
      // ëì—ì„œ ìˆ«ì 4ìë¦¬ë§Œ ì¶”ì¶œ (ìˆ«ì ì•„ë‹Œ ë¬¸ìëŠ” ë¬´ì‹œ)
      const digits = p.replace(/\D/g, '');
      return digits.slice(-4);
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      updateCount();
    }

    function updateCount() {
      const data = loadData();
      document.getElementById('count').textContent = data.length.toString();
    }

    function showMsg(el, text, type='info') {
      el.classList.remove('hidden');
      el.textContent = text;
      el.className = '';
      let base = 'text-sm mt-3';
      if (type === 'success') el.className = base + ' text-emerald-700';
      else if (type === 'error') el.className = base + ' text-rose-700';
      else el.className = base + ' text-gray-700';
    }

    function toRecord(r) {
      return {
        ì´ë¦„: (r['ì´ë¦„'] ?? r['name'] ?? '').toString().trim(),
        ì†Œì†: (r['ì†Œì†'] ?? r['dept'] ?? r['ë¶€ì„œ'] ?? '').toString().trim(),
        ì „í™”ë²ˆí˜¸: (r['ì „í™”ë²ˆí˜¸'] ?? r['phone'] ?? '').toString().trim(),
        ì°¨ëŸ‰ë²ˆí˜¸: normalizePlate(r['ì°¨ëŸ‰ë²ˆí˜¸'] ?? r['plate'] ?? r['ì°¨ëŸ‰ ë²ˆí˜¸'] ?? r['car'] ?? ''),
      }
    }

    function validateRecord(rec) {
      if (!rec.ì´ë¦„ || !rec.ì†Œì† || !rec.ì „í™”ë²ˆí˜¸ || !rec.ì°¨ëŸ‰ë²ˆí˜¸) return false;
      return true;
    }

    function upsert(data, rec) {
      const idx = data.findIndex(d => normalizePlate(d.ì°¨ëŸ‰ë²ˆí˜¸) === rec.ì°¨ëŸ‰ë²ˆí˜¸);
      if (idx >= 0) {
        data[idx] = rec; // ë®ì–´ì“°ê¸°
        return { action: 'updated' };
      } else {
        data.push(rec);
        return { action: 'inserted' };
      }
    }

    function renderCards(list, container) {
      container.innerHTML = '';
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500">ì—†ìŒ</div>';
        return;
      }
      for (const item of list) {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border p-3 mb-3';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${item.ì´ë¦„} <span class="text-xs text-gray-500">(${item.ì†Œì†})</span></div>
            <div class="text-sm text-gray-700">${item.ì „í™”ë²ˆí˜¸}</div>
          </div>
          <div class="mt-2 text-lg tracking-wide">ğŸš— ${item.ì°¨ëŸ‰ë²ˆí˜¸}</div>
        `;
        container.appendChild(card);
      }
    }

    // --- ì´ˆê¸°í™” ---
    updateCount();

    // --- ì—‘ì…€ ê°€ì ¸ì˜¤ê¸° ---
    document.getElementById('btnImport').addEventListener('click', () => {
      const fileInput = document.getElementById('excelFile');
      const msg = document.getElementById('importMsg');
      const file = fileInput.files?.[0];
      if (!file) return showMsg(msg, 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

          const store = loadData();
          let inserted = 0, updated = 0, skipped = 0;

          for (const row of json) {
            const rec = toRecord(row);
            if (!validateRecord(rec)) { skipped++; continue; }
            const res = upsert(store, rec);
            if (res.action === 'inserted') inserted++; else updated++;
          }
          saveData(store);
          showMsg(msg, `ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: ì¶”ê°€ ${inserted}ê±´ Â· ìˆ˜ì • ${updated}ê±´ Â· ê±´ë„ˆëœ€ ${skipped}ê±´`, 'success');
          fileInput.value = '';
        } catch (err) {
          console.error(err);
          showMsg(msg, 'íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // --- ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° ---
    document.getElementById('btnExport').addEventListener('click', () => {
      const data = loadData();
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ì°¨ëŸ‰ë°ì´í„°');
      XLSX.writeFile(wb, 'vehicle_data.xlsx');
    });

    // --- ì „ì²´ ì‚­ì œ ---
    document.getElementById('btnClear').addEventListener('click', () => {
      if (!confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      localStorage.removeItem(STORAGE_KEY);
      updateCount();
      document.getElementById('searchResult').innerHTML = '';
      showMsg(document.getElementById('importMsg'), 'ë°ì´í„°ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.', 'success');
    });

    // --- ê²€ìƒ‰ ---
    function doSearch() {
      const input = document.getElementById('searchLast4');
      const val = input.value.replace(/\D/g, '');
      if (val.length !== 4) {
        renderCards([], document.getElementById('searchResult'));
        return;
      }
      const data = loadData();
      const found = data.filter(item => last4(item.ì°¨ëŸ‰ë²ˆí˜¸) === val);
      renderCards(found, document.getElementById('searchResult'));
    }

    document.getElementById('btnSearch').addEventListener('click', doSearch);
    document.getElementById('searchLast4').addEventListener('input', (e) => {
      // ìˆ«ìë§Œ í—ˆìš© & 4ìë¦¬ ì œí•œ
      e.target.value = e.target.value.replace(/\D/g, '').slice(0,4);
      // ì…ë ¥í•˜ë©´ì„œ ì¦‰ì‹œ ê²€ìƒ‰
      doSearch();
    });

    // --- ë“±ë¡ ---
    document.getElementById('addForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = document.getElementById('addMsg');
      const name = document.getElementById('name').value.trim();
      const dept = document.getElementById('dept').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const plate = normalizePlate(document.getElementById('plate').value);

      if (!name || !dept || !phone || !plate) {
        return showMsg(msg, 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      }

      const rec = { ì´ë¦„: name, ì†Œì†: dept, ì „í™”ë²ˆí˜¸: phone, ì°¨ëŸ‰ë²ˆí˜¸: plate };
      const store = loadData();
      const existsIdx = store.findIndex(d => normalizePlate(d.ì°¨ëŸ‰ë²ˆí˜¸) === plate);

      if (existsIdx >= 0) {
        if (!confirm('ë™ì¼ ì°¨ëŸ‰ë²ˆí˜¸ê°€ ìˆì–´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ê¹Œìš”?')) {
          return showMsg(msg, 'ë“±ë¡ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.', 'info');
        }
        store[existsIdx] = rec;
        saveData(store);
        showMsg(msg, 'ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì¼ìŠµë‹ˆë‹¤.', 'success');
      } else {
        store.push(rec);
        saveData(store);
        showMsg(msg, 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }

      // í¼ ë¦¬ì…‹
      e.target.reset();
      // ë°©ê¸ˆ ë“±ë¡í•œ ë²ˆí˜¸ë¡œ ê²€ìƒ‰ê²°ê³¼ ì—…ë°ì´íŠ¸
      document.getElementById('searchLast4').value = last4(plate);
      doSearch();
    });
  </script>
</body>
</html>
