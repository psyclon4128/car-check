<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>국세공무원교육원 차량조회·등록</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    body { -webkit-font-smoothing: antialiased; }
  </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col">
  <div class="max-w-screen-sm mx-auto bg-white rounded-xl shadow-md p-4 sm:p-6 flex-1">

    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center">
        <a href="https://car-check.onrender.com/" target="_blank">
          <img src="국세공무원교육원.png" alt="국세공무원교육원" class="w-16 h-auto mr-3">
        </a>
        <div>
          <h1 class="text-lg sm:text-2xl font-bold leading-tight">차량조회·등록</h1>
        </div>
      </div>
      <div>
        <button id="loginBtn" onclick="openLoginModal()" class="text-sm text-blue-600 underline">로그인</button>
        <button id="logoutBtn" onclick="logout()" class="hidden text-sm text-red-600 underline">로그아웃</button>
      </div>
    </div>

    <section class="mb-4">
      <label class="block text-sm font-medium mb-2">차량번호 검색</label>
      <input id="searchNum" type="text" maxlength="4" placeholder="차량번호 뒷자리 4자리"
             class="w-full p-3 border rounded-lg mb-3 text-base">
      <button id="searchBtn" onclick="searchCar()" class="w-full bg-blue-600 text-white py-3 rounded-lg text-base" disabled>검색 (로그인 필요)</button>
      <div id="searchResult" class="mt-4 text-sm"></div>
    </section>

    <section id="adminMenu" class="hidden space-y-3">

      <details>
        <summary class="cursor-pointer text-base font-semibold bg-gray-100 p-3 rounded-lg">신규 등록</summary>
        <div class="mt-3">
          <input id="name" placeholder="이름" class="w-full p-2 border rounded-lg mb-2">
          <label class="block mb-1 text-sm">소속</label>
          <select id="org" class="w-full p-2 border rounded-lg mb-2 text-base">
            <option value="국세공무원교육원">국세공무원교육원</option>
            <option value="국세상담센터">국세상담센터</option>
            <option value="주류면허지원센터">주류면허지원센터</option>
            <option value="서귀포지서">서귀포지서</option>
            <option value="재직교육생">재직교육생</option>
            <option value="신규교육생">신규교육생</option>
            <option value="기타">기타</option>
          </select>
          <input id="phone" placeholder="전화번호 (010-1234-5678)" class="w-full p-2 border rounded-lg mb-2">
          <input id="carNum" placeholder="차량번호 (12가3456)" class="w-full p-2 border rounded-lg mb-2">
          <input id="carType" placeholder="차종" class="w-full p-2 border rounded-lg mb-2">
          <label class="block mb-1 text-sm">출입기간</label>
          <select id="expireOption" class="w-full p-2 border rounded-lg mb-2" onchange="toggleExpireDate()">
            <option value="always">항상</option>
            <option value="date">날짜 선택</option>
          </select>
          <input id="expireDate" type="date" class="w-full p-2 border rounded-lg mb-3 hidden">
          <button onclick="saveData()" class="w-full bg-green-600 text-white py-2 rounded-lg text-base">등록</button>
        </div>
      </details>

      <details>
        <summary class="cursor-pointer text-base font-semibold bg-gray-100 p-3 rounded-lg">엑셀 업로드</summary>
        <div class="mt-3">
          <input type="file" id="excelFile" class="w-full mb-2 text-sm">
          <button onclick="uploadExcel()" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm">엑셀 업로드 실행</button>
        </div>
      </details>

    </section>

  </div>

  <div class="text-right w-full p-2 text-xs text-gray-500 mt-auto">made by Banseok Kim</div>

  <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-4 w-11/12 max-w-sm relative">
      <button onclick="closeLoginModal()" class="absolute top-2 right-3 text-gray-500 text-xl">&times;</button>
      <h2 class="text-lg font-bold mb-3 text-center">로그인</h2>
      <input id="loginId" type="text" placeholder="아이디 (admin 또는 user)" class="w-full p-2 border rounded-lg mb-2">
      <input id="loginPw" type="password" placeholder="비밀번호" class="w-full p-2 border rounded-lg mb-2">
      <div class="flex gap-2">
        <button onclick="checkLogin()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">로그인</button>
        <button onclick="closeLoginModal()" class="flex-1 bg-gray-300 text-black py-2 rounded-lg">취소</button>
      </div>
      <p id="loginMsg" class="text-red-500 text-sm mt-2 text-center"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyB-yJWX6qRnkWpHWLqyWyr6NFw7kQDPStA",
      authDomain: "car-check-ae332.firebaseapp.com",
      projectId: "car-check-ae332",
    });

    const db = getFirestore(app);
    const SECRET = "MySecretKey2025!";

    const enc = (t) => CryptoJS.AES.encrypt(String(t || ''), SECRET).toString();
    const dec = (t) => { try { return CryptoJS.AES.decrypt(t, SECRET).toString(CryptoJS.enc.Utf8); } catch { return t; } };

    let currentRole = null;

    window.checkLogin = () => {
      const id = document.getElementById("loginId").value.trim();
      const pw = document.getElementById("loginPw").value.trim();
      if (id === "admin" && pw === "rydbrdnjs1!") {
        currentRole = "admin";
      } else if (id === "user" && pw === "12345") {
        currentRole = "user";
      } else {
        document.getElementById("loginMsg").innerText = "로그인 실패: 잘못된 아이디 또는 비밀번호입니다.";
        return;
      }
      applyRole();
      closeLoginModal();
      alert("로그인 성공!");
    };

    window.logout = () => {
      currentRole = null;
      applyRole();
      alert("로그아웃 되었습니다.");
    };

    function applyRole() {
      document.getElementById("searchBtn").disabled = !currentRole;
      document.getElementById("adminMenu").classList.toggle("hidden", currentRole !== "admin");
      document.getElementById("loginBtn").classList.toggle("hidden", !!currentRole);
      document.getElementById("logoutBtn").classList.toggle("hidden", !currentRole);
      document.getElementById("searchBtn").innerText = currentRole ? "검색" : "검색 (로그인 필요)";
    }

    // ✅ 엑셀 업로드 완전 작동 버전
    window.uploadExcel = async () => {
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      if (!file) {
        alert("엑셀 파일을 선택해주세요.");
        return;
      }

      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);

          if (!rows.length) {
            alert("엑셀에 데이터가 없습니다.");
            return;
          }

          let count = 0;
          for (const row of rows) {
            const name = row["이름"] || "";
            const org = row["소속"] || "";
            const phone = row["전화번호"] || "";
            const carNum = row["차량번호"] || "";
            const carType = row["차종"] || "";
            const expire = row["출입기간"] || "항상";

            if (!carNum) continue;

            const encrypted = {
              name: enc(name),
              org: enc(org),
              phone: enc(phone),
              carNum: enc(carNum),
              carType: enc(carType),
              expireDate: enc(expire)
            };

            await setDoc(doc(db, "cars", carNum), encrypted);
            count++;
          }

          alert(`엑셀 업로드 완료! (${count}건 등록됨)`);
          fileInput.value = "";
        };

        reader.readAsArrayBuffer(file);
      } catch (err) {
        console.error(err);
        alert("엑셀 업로드 중 오류 발생: " + err.message);
      }
    };

    window.toggleExpireDate = () => {
      document.getElementById("expireDate").classList.toggle("hidden", document.getElementById("expireOption").value !== "date");
    };

    window.openLoginModal = () => document.getElementById("loginModal").classList.remove("hidden");
    window.closeLoginModal = () => document.getElementById("loginModal").classList.add("hidden");

  </script>

</body>
</html>